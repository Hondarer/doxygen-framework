# doxybook2-decolorize-output.sh ä»•æ§˜

## æ¦‚è¦

`doxybook2-decolorize-output.sh` ã¯ã€Doxybook2 ã®å‡ºåŠ›ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰éå‰°ãª ANSI ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»ã™ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚`[info]` ãƒ­ã‚°ã‚’å®Œå…¨ã«è„±è‰²ã—ã€`[warning]` / `[error]` / `[critical]` ã®å¤ªå­—ã‚’é™¤å»ã—ã¾ã™ã€‚

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

```text
doxybook2-decolorize-output.sh
```

## å®Ÿè¡Œæ¨©é™

å®Ÿè¡Œå¯èƒ½ (chmod +x)

## æ©Ÿèƒ½

æ¨™æº–å…¥åŠ›ã‹ã‚‰å—ã‘å–ã£ãŸå„è¡Œã‚’è§£æã—ã€ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ ANSI ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»ã¾ãŸã¯èª¿æ•´ã—ã¾ã™ã€‚

### å‡¦ç†ãƒ«ãƒ¼ãƒ«

| ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« | æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ | å‡¦ç†å†…å®¹ | å‡¦ç†å¾Œã®è¡¨ç¤º |
|------------|--------------|----------|--------------|
| Info | `[info]` | å…¨ã¦ã® ANSI ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (ç€è‰²ãªã—) |
| Critical | `[critical]` | å…¨ã¦ã® ANSI ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦èµ¤è‰²ã«å¤‰æ› | ğŸ”´ èµ¤ (é€šå¸¸ã®å¤ªã•ã€èƒŒæ™¯ãªã—) |
| Warning | `[warning]` | å¤ªå­—ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»ã€é»„è‰²ã¯ç¶­æŒ | ğŸŸ¡ é»„ (é€šå¸¸ã®å¤ªã•) |
| Error | `[error]` | å¤ªå­—ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»ã€èµ¤è‰²ã¯ç¶­æŒ | ğŸ”´ èµ¤ (é€šå¸¸ã®å¤ªã•) |
| ãã®ä»– | (è©²å½“ãªã—) | ãã®ã¾ã¾å‡ºåŠ› | å¤‰æ›´ãªã— |

## å®Ÿè£…è©³ç´°

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```plantuml
@startuml å‡¦ç†ãƒ•ãƒ­ãƒ¼
caption å‡¦ç†ãƒ•ãƒ­ãƒ¼

start
while (æ¨™æº–å…¥åŠ›ã«è¡ŒãŒã‚ã‚‹?) is (yes)
  :è¡Œã‚’èª­ã¿å–ã‚Š;
  if ('[info]' ã‚’å«ã‚€?) then (yes)
    :å…¨ã¦ã® ANSI ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤;
    :è„±è‰²ã—ã¦å‡ºåŠ›;
  elseif ('[critical]' ã‚’å«ã‚€?) then (yes)
    :å…¨ã¦ã® ANSI ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤;
    :èµ¤è‰² (\\033[0;31m) ã§å‡ºåŠ›;
  elseif ('[warning]' ã¾ãŸã¯ '[error]' ã‚’å«ã‚€?) then (yes)
    :å¤ªå­—ã‚³ãƒ¼ãƒ‰ (\\033[1;) ã‚’é€šå¸¸ (\\033[0;) ã«å¤‰æ›;
    :èª¿æ•´ã—ã¦å‡ºåŠ›;
  else (no)
    :ãã®ã¾ã¾å‡ºåŠ›;
  endif
endwhile (no)
stop

@enduml
```

### ãƒãƒƒãƒãƒ³ã‚°æ¡ä»¶

#### Info ãƒ­ã‚°ã®æ¤œå‡º

```bash
if [[ "$line" == *"[info]"* ]]; then
```

è¡Œå†…ã« `[info]` ãŒå«ã¾ã‚Œã‚‹å ´åˆã«ãƒãƒƒãƒã—ã¾ã™ã€‚

#### Critical ãƒ­ã‚°ã®æ¤œå‡º

```bash
elif [[ "$line" == *"[critical]"* ]]; then
```

è¡Œå†…ã« `[critical]` ãŒå«ã¾ã‚Œã‚‹å ´åˆã«ãƒãƒƒãƒã—ã¾ã™ã€‚

#### Warning/Error ãƒ­ã‚°ã®æ¤œå‡º

```bash
elif [[ "$line" == *"[warning]"* ]] || [[ "$line" == *"[error]"* ]]; then
```

è¡Œå†…ã« `[warning]` ã¾ãŸã¯ `[error]` ãŒå«ã¾ã‚Œã‚‹å ´åˆã«ãƒãƒƒãƒã—ã¾ã™ã€‚

### ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã®é™¤å»ãƒ»å¤‰æ›

#### Info ãƒ­ã‚°ã®å®Œå…¨è„±è‰²

```bash
# å…¨ã¦ã® ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ (\033[XXm å½¢å¼) ã‚’å‰Šé™¤
echo "$line" | sed 's/\x1b\[[0-9;]*m//g'
```

æ­£è¦è¡¨ç¾ã®èª¬æ˜:
- `\x1b`: ESC æ–‡å­— (8 é€²æ•° 033)
- `\[`: å·¦è§’æ‹¬å¼§
- `[0-9;]*`: æ•°å­—ã¨ã‚»ãƒŸã‚³ãƒ­ãƒ³ã® 0 å›ä»¥ä¸Šã®ç¹°ã‚Šè¿”ã—
- `m`: çµ‚ç«¯æ–‡å­—

#### Critical ãƒ­ã‚°ã®å®Œå…¨è„±è‰²ã¨èµ¤è‰²é©ç”¨

```bash
# å…¨ã¦ã® ANSI ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
cleaned=$(echo "$line" | sed 's/\x1b\[[0-9;]*m//g')
# é€šå¸¸ã®èµ¤è‰²ã§å…¨è¡Œã‚’å‡ºåŠ›
echo -e "\033[0;31m${cleaned}\033[0m"
```

å‡¦ç†å†…å®¹:
- å¤ªå­— + èµ¤èƒŒæ™¯ (`\033[1;41m`) ã‚’å«ã‚€å…¨ã¦ã® ANSI ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»
- é€šå¸¸ã®å¤ªã•ã®èµ¤æ–‡å­— (`\033[0;31m`) ã§å†ç€è‰²

#### Warning/Error ãƒ­ã‚°ã®å¤ªå­—é™¤å»

```bash
# å¤ªå­—ã‚³ãƒ¼ãƒ‰ (\033[1;XX) ã‚’é€šå¸¸ã®å¤ªã• (\033[0;XX) ã«å¤‰æ›
echo "$line" | sed 's/\x1b\[1;/\x1b[0;/g'
```

å¤‰æ›ä¾‹:
- `\033[1;33m` (å¤ªå­— + é»„è‰²) â†’ `\033[0;33m` (é€šå¸¸ + é»„è‰²)
- `\033[1;31m` (å¤ªå­— + èµ¤è‰²) â†’ `\033[0;31m` (é€šå¸¸ + èµ¤è‰²)

### è¨­è¨ˆä¸Šã®è€ƒæ…®äº‹é …

#### Doxygen ç€è‰²ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã®å¯¾æ¯”

| é …ç›® | doxygen-colorize-output.sh | doxybook2-decolorize-output.sh |
|------|----------------------------|--------------------------------|
| ç›®çš„ | ç€è‰²ã‚’ **è¿½åŠ ** | ç€è‰²ã‚’ **å‰Šé™¤/èª¿æ•´** |
| å¯¾è±¡ | error, warning | info, warning, error |
| å‡¦ç† | ANSI ã‚³ãƒ¼ãƒ‰ã‚’ä»˜ä¸ | ANSI ã‚³ãƒ¼ãƒ‰ã‚’é™¤å»/å¤‰æ› |
| ç†ç”± | ç€è‰²ãŒä¸è¶³ | ç€è‰²ãŒéå‰° |

#### ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã®ç°¡æ½”æ€§

`[info]` ã®å½¢å¼ã¯ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã¾ãªã„æ˜ç¢ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã‚ã‚‹ãŸã‚ã€èª¤æ¤œçŸ¥ã®å¯èƒ½æ€§ãŒä½ãã€ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒãƒãƒ³ã‚°ã§ååˆ†ã§ã™ã€‚

## ä½¿ç”¨æ–¹æ³•

### Makefile ã‹ã‚‰ã®å‘¼ã³å‡ºã—

```bash
doxybook2 -i ../xml -o ../docs-src/doxybook --config doxybook-config.json --templates templates 2>&1 | $(MAKEFILE_DIR)/doxybook2-decolorize-output.sh
```

- `2>&1`: stderr ã‚’ stdout ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦çµåˆ
- `|`: ãƒ‘ã‚¤ãƒ—ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«æ¸¡ã™

### çµ‚äº†ã‚³ãƒ¼ãƒ‰ã®ä¿æŒ

```bash
doxybook2 -i ../xml -o ../docs-src/doxybook --config doxybook-config.json --templates templates 2>&1 | $(MAKEFILE_DIR)/doxybook2-decolorize-output.sh;
DOXYBOOK_EXIT=${PIPESTATUS[0]};
exit $DOXYBOOK_EXIT;
```

`PIPESTATUS[0]` ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ‘ã‚¤ãƒ—ã®æœ€åˆã®ã‚³ãƒãƒ³ãƒ‰ (doxybook2) ã®çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ã—ã€ãƒ“ãƒ«ãƒ‰ã®æˆå¦ã‚’æ­£ã—ãåˆ¤å®šã—ã¾ã™ã€‚

## å‡ºåŠ›ä¾‹

### å‡¦ç†å‰

```text
[2025-11-26 10:30:15.123] [info] Processing file calculator.h
[2025-11-26 10:30:15.124] [warning] Missing brief description
[2025-11-26 10:30:15.125] [error] Failed to parse member
[2025-11-26 10:30:15.126] [critical] Fatal error occurred
```

(ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã¯ `[info]` ãŒç·‘ã€`[warning]` ãŒå¤ªå­—é»„è‰²ã€`[error]` ãŒå¤ªå­—èµ¤è‰²ã€`[critical]` ãŒå¤ªå­— + èµ¤èƒŒæ™¯ã§è¡¨ç¤º)

### å‡¦ç†å¾Œ

```text
[2025-11-26 10:30:15.123] [info] Processing file calculator.h
```
<span style="color: #ffaa00">[2025-11-26 10:30:15.124] [warning] Missing brief description</span>
<span style="color: #ff0000">[2025-11-26 10:30:15.125] [error] Failed to parse member</span>
<span style="color: #ff0000">[2025-11-26 10:30:15.126] [critical] Fatal error occurred</span>

(`[info]` ã¯ç€è‰²ãªã—ã€`[warning]` ã¯é€šå¸¸ã®å¤ªã•ã®é»„è‰²ã€`[error]` ã¨ `[critical]` ã¯é€šå¸¸ã®å¤ªã•ã®èµ¤è‰²ã§è¡¨ç¤º)

## åˆ¶é™äº‹é …

### ANSI ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰éå¯¾å¿œç’°å¢ƒ

å…ƒã€… ANSI ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã—ã¦ã„ãªã„ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã¯ã€Doxybook2 è‡ªä½“ãŒç€è‰²ã‚’å‡ºåŠ›ã—ãªã„ãŸã‚ã€æœ¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åŠ¹æœã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

### ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®å‡ºåŠ›

ANSI ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€å‡ºåŠ›ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹å ´åˆã€æœ¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¸è¦ãªã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’é˜²ã’ã¾ã™ã€‚

```bash
# æ¨å¥¨: ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨ã—ã¦ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
doxybook2 ... 2>&1 | doxybook2-decolorize-output.sh | tee doxybook2.log
```

## ãƒ†ã‚¹ãƒˆæ–¹æ³•

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆå˜ä½“ã®ãƒ†ã‚¹ãƒˆãŒå¯èƒ½ã§ã™ã€‚

```bash
cat <<'EOF' | doxybook2-decolorize-output.sh
Normal output line
[2025-11-26 10:30:15.123] [info] Processing file
Another normal line
[2025-11-26 10:30:15.124] [warning] Missing description
[2025-11-26 10:30:15.125] [error] Parse failed
[2025-11-26 10:30:15.126] [critical] Fatal error
More normal output
EOF
```

æœŸå¾…ã•ã‚Œã‚‹çµæœ:
- `[info]` è¡Œ: ANSI ã‚³ãƒ¼ãƒ‰ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹
- `[critical]` è¡Œ: ANSI ã‚³ãƒ¼ãƒ‰ãŒå‰Šé™¤ã•ã‚Œã€é€šå¸¸ã®å¤ªã•ã®èµ¤è‰²ã«ãªã‚‹
- `[warning]` è¡Œ: å¤ªå­—ãŒé™¤å»ã•ã‚Œã€é€šå¸¸ã®å¤ªã•ã®é»„è‰²ã«ãªã‚‹
- `[error]` è¡Œ: å¤ªå­—ãŒé™¤å»ã•ã‚Œã€é€šå¸¸ã®å¤ªã•ã®èµ¤è‰²ã«ãªã‚‹

å®Ÿéš›ã® ANSI ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```bash
cat <<'EOF' | doxybook2-decolorize-output.sh
Normal output line
[2025-11-26 10:30:15.123] [32m[info][0m Processing file
[2025-11-26 10:30:15.124] [1;33m[warning][0m Missing description
[2025-11-26 10:30:15.125] [1;31m[error][0m Parse failed
[2025-11-26 10:30:15.126] [1;41m[critical][0m Fatal error
EOF
```

## é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `Makefile`: æœ¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ doxybook2 å®Ÿè¡Œæ™‚ã«é©ç”¨
- `docs-src/doxybook2-decolorize-output-research.md`: èª¿æŸ»çµæœã¨èƒŒæ™¯æƒ…å ±
- `doxygen-colorize-output.sh`: Doxygen ç”¨ã®ç€è‰²ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (å¯¾æ¯”å‚è€ƒ)
